<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>App Screen Simulator - Interactive APML Validation</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .screen-transition {
      transition: all 0.3s ease;
    }
    .message-box {
      animation: messageAppear 0.4s ease;
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    
    createApp({
      setup() {
        const currentApml = ref(null);
        const selectedScreen = ref('');
        const currentScreenData = ref(null);
        const messageSequence = ref([]);
        const availableScreens = ref([]);
        const userFeedback = ref('');
        const chatHistory = ref([]);
        
        const currentApp = ref('projectchat-app.apml');
        const appScreens = ref([]);
        const screenHistory = ref([]);
        const currentScreenIndex = ref(0);
        
        const loadApp = async (filename) => {
          try {
            const response = await fetch(`/vfs-storage/${filename}`);
            if (!response.ok) throw new Error(`Failed to load ${filename}`);
            const content = await response.text();
            currentApml.value = jsyaml.load(content);
            
            // Extract screens from APML
            if (currentApml.value?.screens) {
              appScreens.value = Object.entries(currentApml.value.screens).map(([key, screen]) => ({
                id: key,
                name: screen.name || key,
                purpose: screen.purpose,
                actions: screen.user_actions || []
              }));
              
              // Load first screen by default
              if (appScreens.value.length > 0) {
                loadScreen(appScreens.value[0]);
              }
            }
          } catch (error) {
            console.error('Failed to load app:', error);
          }
        };
        
        const loadScreen = (screen) => {
          selectedScreen.value = screen.id;
          currentScreenData.value = screen;
          initializeScreen();
        };
        
        const initializeScreen = () => {
          messageSequence.value = [];
          
          // Show initial screen load sequence
          messageSequence.value.push({
            type: 'app-to-user',
            content: `Screen loaded: ${currentScreenData.value?.name}`,
            timestamp: Date.now()
          });
        };
        
        const getScreenButtons = () => {
          if (!currentScreenData.value?.actions) return [];
          
          return currentScreenData.value.actions.map((actionObj, index) => ({
            id: `btn-${index}`,
            label: actionObj.action,
            description: actionObj.description,
            action: actionObj.action,
            nextScreen: actionObj.next_screen
          }));
        };
        
        const handleButtonClick = (button) => {
          // Start APML sequence: User → App
          messageSequence.value.push({
            type: 'user-to-app',
            content: button.action,
            timestamp: Date.now()
          });
          
          // Trigger App → App processes
          setTimeout(() => {
            triggerAppProcesses(button);
          }, 500);
          
          // Show final App → User result and screen transition
          setTimeout(() => {
            showAppResponse(button);
            transitionToNextScreen(button);
          }, 1500);
        };
        
        const triggerAppProcesses = (button) => {
          if (!currentApml.value?.patterns?.app_to_app) return;
          
          const processes = currentApml.value.patterns.app_to_app;
          processes.forEach((process, index) => {
            setTimeout(() => {
              messageSequence.value.push({
                type: 'app-to-app',
                content: process,
                timestamp: Date.now()
              });
            }, index * 300);
          });
        };
        
        const showAppResponse = (button) => {
          if (!currentApml.value?.patterns?.app_to_user) return;
          
          const responses = currentApml.value.patterns.app_to_user;
          const contextualResponse = getContextualResponse(button.action, responses);
          
          messageSequence.value.push({
            type: 'app-to-user',
            content: contextualResponse,
            timestamp: Date.now()
          });
        };
        
        const transitionToNextScreen = (button) => {
          if (button.nextScreen) {
            // Find the next screen in appScreens
            const nextScreen = appScreens.value.find(screen => screen.id === button.nextScreen);
            if (nextScreen) {
              // Add screen transition to APML sequence
              messageSequence.value.push({
                type: 'app-to-user',
                content: `Screen transition: Navigate to ${nextScreen.name}`,
                timestamp: Date.now()
              });
              
              // Update screen history
              screenHistory.value.push(currentScreenData.value);
              
              // Transition to next screen
              currentScreenData.value = nextScreen;
              selectedScreen.value = nextScreen.id;
            }
          }
        };
        
        const goBackToPreviousScreen = () => {
          if (screenHistory.value.length > 0) {
            const previousScreen = screenHistory.value.pop();
            currentScreenData.value = previousScreen;
            selectedScreen.value = previousScreen.id;
            
            messageSequence.value.push({
              type: 'app-to-user',
              content: `Screen transition: Back to ${previousScreen.name}`,
              timestamp: Date.now()
            });
          }
        };
        
        const sendChatMessage = () => {
          if (!userFeedback.value.trim()) return;
          
          chatHistory.value.push({
            type: 'user',
            content: userFeedback.value,
            timestamp: Date.now()
          });
          
          // Simulate ADE response
          setTimeout(() => {
            chatHistory.value.push({
              type: 'ade',
              content: `Thanks for the feedback about: "${userFeedback.value}". I'll incorporate this into the APML validation.`,
              timestamp: Date.now()
            });
          }, 1000);
          
          userFeedback.value = '';
        };
        
        const getContextualResponse = (userAction, appResponses) => {
          // Simple contextual matching
          const action = userAction.toLowerCase();
          
          if (action.includes('describe') || action.includes('requirements')) {
            return appResponses.find(r => r.includes('generated') || r.includes('display')) || appResponses[0];
          }
          
          if (action.includes('select') || action.includes('choose')) {
            return appResponses.find(r => r.includes('status') || r.includes('options')) || appResponses[1];
          }
          
          if (action.includes('deploy') || action.includes('confirm')) {
            return appResponses.find(r => r.includes('deployment') || r.includes('complete')) || appResponses[appResponses.length - 1];
          }
          
          // Default to random response
          return appResponses[Math.floor(Math.random() * appResponses.length)];
        };
        
        const clearMessageSequence = () => {
          messageSequence.value = [];
        };
        
        const resetScreen = () => {
          screenHistory.value = [];
          if (appScreens.value.length > 0) {
            loadScreen(appScreens.value[0]);
          }
        };
        
        const getSequenceStats = () => {
          const userToApp = messageSequence.value.filter(m => m.type === 'user-to-app').length;
          const appToApp = messageSequence.value.filter(m => m.type === 'app-to-app').length;
          const appToUser = messageSequence.value.filter(m => m.type === 'app-to-user').length;
          
          return { userToApp, appToApp, appToUser };
        };
        
        onMounted(() => {
          // Load ProjectChat app by default
          loadApp('projectchat-app.apml');
        });
        
        return {
          currentApml,
          selectedScreen,
          currentScreenData,
          messageSequence,
          userFeedback,
          chatHistory,
          appScreens,
          screenHistory,
          loadApp,
          loadScreen,
          getScreenButtons,
          handleButtonClick,
          sendChatMessage,
          clearMessageSequence,
          resetScreen,
          getSequenceStats,
          transitionToNextScreen,
          goBackToPreviousScreen
        };
      },
      
      template: `
        <div class="min-h-screen bg-gray-900 text-white">
          <!-- Header -->
          <header class="bg-gray-800 border-b border-gray-700 p-4">
            <div class="flex items-center justify-between">
              <h1 class="text-xl font-bold">App Screen Simulator</h1>
              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-400">
                  <span v-if="screenHistory.length > 0">
                    {{ screenHistory[screenHistory.length - 1]?.name }} → 
                  </span>
                  <span class="font-semibold">{{ currentScreenData?.name || 'None' }}</span>
                </div>
                <button 
                  v-if="screenHistory.length > 0"
                  @click="goBackToPreviousScreen"
                  class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm"
                >
                  ← Back
                </button>
                <button 
                  @click="resetScreen"
                  class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm"
                >
                  Reset
                </button>
                <button 
                  @click="clearMessageSequence"
                  class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm"
                >
                  Clear Sequence
                </button>
              </div>
            </div>
          </header>
          
          <div class="flex h-screen">
            <!-- Left Panel: App Screens + Chat -->
            <div class="w-1/4 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto flex flex-col">
              <!-- App Screens Section -->
              <div class="flex-1">
                <h2 class="text-lg font-semibold mb-4">ProjectChat Screens</h2>
                
                <!-- Current Screen -->
                <div v-if="currentScreenData" class="mb-4 p-3 bg-blue-900 rounded">
                  <div class="font-medium text-blue-100">Current: {{ currentScreenData.name }}</div>
                  <div class="text-xs text-blue-200">{{ currentScreenData.actions?.length || 0 }} actions available</div>
                </div>
                
                <!-- Screen History -->
                <div v-if="screenHistory.length > 0" class="mb-4">
                  <h3 class="text-sm font-medium mb-2 text-gray-400">Screen History:</h3>
                  <div class="space-y-1">
                    <button
                      v-for="(screen, index) in screenHistory.slice(-3)"
                      :key="screen.id + '-' + index"
                      @click="goBackToPreviousScreen"
                      class="w-full text-left px-2 py-1 rounded text-xs bg-gray-700 hover:bg-gray-600 text-gray-300"
                    >
                      ← {{ screen.name }}
                    </button>
                  </div>
                </div>
                
                <!-- Main Screens (organized by category) -->
                <div class="space-y-4">
                  <div>
                    <h3 class="text-sm font-medium mb-2 text-green-400">Main Screens</h3>
                    <div class="space-y-1">
                      <button
                        v-for="screen in appScreens.filter(s => ['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(s.id))"
                        :key="screen.id"
                        @click="loadScreen(screen)"
                        :class="[
                          'w-full text-left px-3 py-2 rounded text-sm transition-colors',
                          selectedScreen === screen.id 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                        ]"
                      >
                        <div class="font-medium">{{ screen.name }}</div>
                        <div class="text-xs text-gray-400">{{ screen.actions?.length || 0 }} actions</div>
                      </button>
                    </div>
                  </div>
                  
                  <div v-if="appScreens.filter(s => !['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(s.id)).length > 0">
                    <h3 class="text-sm font-medium mb-2 text-purple-400">Flow Screens</h3>
                    <div class="space-y-1">
                      <button
                        v-for="screen in appScreens.filter(s => !['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(s.id))"
                        :key="screen.id"
                        @click="loadScreen(screen)"
                        :class="[
                          'w-full text-left px-3 py-2 rounded text-sm transition-colors',
                          selectedScreen === screen.id 
                            ? 'bg-purple-600 text-white' 
                            : 'bg-gray-700 hover:bg-gray-600 text-gray-300'
                        ]"
                      >
                        <div class="font-medium text-xs">{{ screen.name }}</div>
                        <div class="text-xs text-gray-400">{{ screen.actions?.length || 0 }} actions</div>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div v-if="currentScreenData" class="mt-6 p-3 bg-gray-700 rounded">
                  <h3 class="font-medium mb-2">{{ currentScreenData.name }}</h3>
                  <div class="text-xs text-gray-400">
                    <div>{{ currentScreenData.purpose }}</div>
                    <div class="mt-2">{{ currentScreenData.actions?.length || 0 }} user actions available</div>
                  </div>
                </div>
                
                <div v-if="getSequenceStats().userToApp > 0" class="mt-4 p-3 bg-gray-700 rounded">
                  <h3 class="font-medium mb-2">Current Sequence</h3>
                  <div class="text-xs text-gray-400 space-y-1">
                    <div>User Actions: {{ getSequenceStats().userToApp }}</div>
                    <div>App Processes: {{ getSequenceStats().appToApp }}</div>
                    <div>App Responses: {{ getSequenceStats().appToUser }}</div>
                  </div>
                </div>
              </div>
              
              <!-- Chat with ADE Section -->
              <div class="border-t border-gray-700 pt-4 mt-4">
                <h3 class="text-sm font-semibold mb-2">💬 Chat with ADE</h3>
                
                <div class="space-y-2 mb-3 max-h-32 overflow-y-auto">
                  <div
                    v-for="chat in chatHistory"
                    :key="chat.timestamp"
                    :class="[
                      'p-2 rounded text-xs',
                      chat.type === 'user' ? 'bg-green-800 text-green-100' : 'bg-blue-800 text-blue-100'
                    ]"
                  >
                    <div class="font-medium">{{ chat.type === 'user' ? 'You' : 'ADE' }}</div>
                    <div>{{ chat.content }}</div>
                  </div>
                </div>
                
                <div class="flex">
                  <input
                    v-model="userFeedback"
                    @keyup.enter="sendChatMessage"
                    placeholder="Tell ADE your thoughts..."
                    class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-l text-xs text-white"
                  />
                  <button
                    @click="sendChatMessage"
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-r text-xs text-white"
                  >
                    Send
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Center Panel: App Screen Mockup -->
            <div class="w-1/2 bg-gray-900 p-4 overflow-y-auto">
              <h2 class="text-lg font-semibold mb-4">App Screen Mockup</h2>
              
              <div v-if="!currentScreenData" class="text-center text-gray-400 mt-20">
                <div class="text-6xl mb-4">📱</div>
                <p>Select a screen to view its mockup</p>
              </div>
              
              <div v-else class="space-y-4">
                <!-- App Screen Mockup -->
                <div class="bg-white rounded-lg p-6 max-w-md mx-auto" style="width: 300px; height: 500px;">
                  <div class="text-center mb-4">
                    <h3 class="text-lg font-bold text-gray-800">{{ currentScreenData.name }}</h3>
                    <p class="text-sm text-gray-600">{{ currentScreenData.purpose }}</p>
                    <div v-if="screenHistory.length > 0" class="mt-2">
                      <button 
                        @click="goBackToPreviousScreen"
                        class="text-xs px-2 py-1 bg-gray-200 hover:bg-gray-300 rounded"
                      >
                        ← Back to {{ screenHistory[screenHistory.length - 1]?.name }}
                      </button>
                    </div>
                  </div>
                  
                  <!-- Interactive Buttons -->
                  <div class="space-y-3">
                    <button
                      v-for="button in getScreenButtons()"
                      :key="button.id"
                      @click="handleButtonClick(button)"
                      :title="button.description"
                      class="w-full p-3 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-left relative group"
                    >
                      <div class="text-sm font-medium">{{ button.label }}</div>
                      <div class="text-xs opacity-75">Tap to trigger APML sequence</div>
                      
                      <!-- Hover tooltip -->
                      <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity z-10 whitespace-nowrap">
                        {{ button.description }}
                      </div>
                    </button>
                  </div>
                  
                  <!-- Screen Info -->
                  <div class="mt-6 p-3 bg-gray-100 rounded text-xs text-gray-600">
                    <div>Screen: {{ currentScreenData.id }}</div>
                    <div>Actions: {{ getScreenButtons().length }}</div>
                  </div>
                </div>
                
                <!-- Button Explanations -->
                <div v-if="getScreenButtons().length > 0" class="max-w-md mx-auto p-3 bg-gray-800 rounded">
                  <h4 class="text-sm font-semibold mb-2 text-gray-300">Available Actions:</h4>
                  <div class="space-y-1">
                    <div v-for="button in getScreenButtons()" :key="button.id" class="text-xs text-gray-400">
                      <span class="font-medium text-blue-400">{{ button.label }}:</span> {{ button.description }}
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel: APML Sequence -->
            <div class="w-1/4 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto">
              <h2 class="text-lg font-semibold mb-4">APML Sequence</h2>
              
              <div v-if="messageSequence.length > 0" class="space-y-2 mb-4">
                <div
                  v-for="message in messageSequence"
                  :key="message.timestamp"
                  :class="[
                    'p-3 rounded text-sm',
                    message.type === 'user-to-app' ? 'bg-green-900 text-green-100' :
                    message.type === 'app-to-app' ? 'bg-purple-900 text-purple-100' :
                    'bg-blue-900 text-blue-100'
                  ]"
                >
                  <div class="font-medium mb-1">{{ message.type.replace('-', ' → ').toUpperCase() }}</div>
                  <div>{{ message.content }}</div>
                </div>
              </div>
              
              <div v-else class="text-center text-gray-400 mt-20">
                <div class="text-4xl mb-4">🔄</div>
                <p class="text-sm">APML sequence will appear here when you interact with buttons in the center panel</p>
              </div>
              
              <div class="mt-6 p-3 bg-gray-900 rounded border border-gray-600">
                <p class="text-xs text-gray-400">
                  <strong>🎯 APML Validation:</strong> Click buttons in the center panel to see the exact sequence of User→App, App→App, and App→User messages that would be triggered.
                </p>
              </div>
            </div>
          </div>
        </div>
      `
    }).mount('#app');
  </script>
</body>
</html>