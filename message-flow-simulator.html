<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProjectChat - App Experience Simulator</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://unpkg.com/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .screen-transition {
      transition: all 0.3s ease;
    }
    .message-box {
      animation: messageAppear 0.4s ease;
    }
    @keyframes messageAppear {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script>
    const { createApp, ref, reactive, computed, onMounted } = Vue;
    
    createApp({
      setup() {
        const currentApml = ref(null);
        const selectedScreen = ref('');
        const currentScreenData = ref(null);
        const messageSequence = ref([]);
        const availableScreens = ref([]);
        const userFeedback = ref('');
        const chatHistory = ref([]);
        
        const currentApp = ref('projectchat-app.apml');
        const appScreens = ref([]);
        const screenHistory = ref([]);
        const currentScreenIndex = ref(0);
        const showTechnicalDetails = ref(false);
        
        const loadApp = async (filename) => {
          try {
            const response = await fetch(`/vfs-storage/${filename}`);
            if (!response.ok) throw new Error(`Failed to load ${filename}`);
            const content = await response.text();
            currentApml.value = jsyaml.load(content);
            
            // Extract screens from APML
            if (currentApml.value?.screens) {
              appScreens.value = Object.entries(currentApml.value.screens).map(([key, screen]) => ({
                id: key,
                name: screen.name || key,
                purpose: screen.purpose,
                actions: screen.user_actions || []
              }));
              
              // Load first screen by default
              if (appScreens.value.length > 0) {
                loadScreen(appScreens.value[0]);
              }
            }
          } catch (error) {
            console.error('Failed to load app:', error);
          }
        };
        
        const loadScreen = (screen) => {
          selectedScreen.value = screen.id;
          currentScreenData.value = screen;
          initializeScreen();
        };
        
        const initializeScreen = () => {
          messageSequence.value = [];
          
          // Show initial screen load sequence
          messageSequence.value.push({
            type: 'app-to-user',
            content: `Screen loaded: ${currentScreenData.value?.name}`,
            timestamp: Date.now()
          });
        };
        
        const getScreenButtons = () => {
          if (!currentScreenData.value?.actions) return [];
          
          return currentScreenData.value.actions.map((actionObj, index) => ({
            id: `btn-${index}`,
            label: actionObj.action,
            description: actionObj.description,
            action: actionObj.action,
            nextScreen: actionObj.next_screen
          }));
        };
        
        const handleButtonClick = (button) => {
          // Start APML sequence: User â†’ App
          messageSequence.value.push({
            type: 'user-to-app',
            content: button.action,
            timestamp: Date.now()
          });
          
          // Trigger App â†’ App processes
          setTimeout(() => {
            triggerAppProcesses(button);
          }, 500);
          
          // Show final App â†’ User result and screen transition
          setTimeout(() => {
            showAppResponse(button);
            transitionToNextScreen(button);
          }, 1500);
        };
        
        const triggerAppProcesses = (button) => {
          if (!currentApml.value?.patterns?.app_to_app) return;
          
          const processes = currentApml.value.patterns.app_to_app;
          processes.forEach((process, index) => {
            setTimeout(() => {
              messageSequence.value.push({
                type: 'app-to-app',
                content: process,
                timestamp: Date.now()
              });
            }, index * 300);
          });
        };
        
        const showAppResponse = (button) => {
          if (!currentApml.value?.patterns?.app_to_user) return;
          
          const responses = currentApml.value.patterns.app_to_user;
          const contextualResponse = getContextualResponse(button.action, responses);
          
          messageSequence.value.push({
            type: 'app-to-user',
            content: contextualResponse,
            timestamp: Date.now()
          });
        };
        
        const transitionToNextScreen = (button) => {
          if (button.nextScreen) {
            // Find the next screen in appScreens
            const nextScreen = appScreens.value.find(screen => screen.id === button.nextScreen);
            if (nextScreen) {
              // Add screen transition to APML sequence
              messageSequence.value.push({
                type: 'app-to-user',
                content: `Screen transition: Navigate to ${nextScreen.name}`,
                timestamp: Date.now()
              });
              
              // Update screen history
              screenHistory.value.push(currentScreenData.value);
              
              // Transition to next screen
              currentScreenData.value = nextScreen;
              selectedScreen.value = nextScreen.id;
            }
          }
        };
        
        const goBackToPreviousScreen = () => {
          if (screenHistory.value.length > 0) {
            const previousScreen = screenHistory.value.pop();
            currentScreenData.value = previousScreen;
            selectedScreen.value = previousScreen.id;
            
            messageSequence.value.push({
              type: 'app-to-user',
              content: `Screen transition: Back to ${previousScreen.name}`,
              timestamp: Date.now()
            });
          }
        };
        
        const sendChatMessage = () => {
          if (!userFeedback.value.trim()) return;
          
          chatHistory.value.push({
            type: 'user',
            content: userFeedback.value,
            timestamp: Date.now()
          });
          
          // Simulate ADE response
          setTimeout(() => {
            chatHistory.value.push({
              type: 'ade',
              content: `Thanks for the feedback about: "${userFeedback.value}". I'll incorporate this into the APML validation.`,
              timestamp: Date.now()
            });
          }, 1000);
          
          userFeedback.value = '';
        };
        
        const getContextualResponse = (userAction, appResponses) => {
          // Simple contextual matching
          const action = userAction.toLowerCase();
          
          if (action.includes('describe') || action.includes('requirements')) {
            return appResponses.find(r => r.includes('generated') || r.includes('display')) || appResponses[0];
          }
          
          if (action.includes('select') || action.includes('choose')) {
            return appResponses.find(r => r.includes('status') || r.includes('options')) || appResponses[1];
          }
          
          if (action.includes('deploy') || action.includes('confirm')) {
            return appResponses.find(r => r.includes('deployment') || r.includes('complete')) || appResponses[appResponses.length - 1];
          }
          
          // Default to random response
          return appResponses[Math.floor(Math.random() * appResponses.length)];
        };
        
        const clearMessageSequence = () => {
          messageSequence.value = [];
        };
        
        const resetScreen = () => {
          screenHistory.value = [];
          if (appScreens.value.length > 0) {
            loadScreen(appScreens.value[0]);
          }
        };
        
        const getSequenceStats = () => {
          const userToApp = messageSequence.value.filter(m => m.type === 'user-to-app').length;
          const appToApp = messageSequence.value.filter(m => m.type === 'app-to-app').length;
          const appToUser = messageSequence.value.filter(m => m.type === 'app-to-user').length;
          
          return { userToApp, appToApp, appToUser };
        };
        
        onMounted(() => {
          // Load ProjectChat app by default
          loadApp('projectchat-app.apml');
        });
        
        return {
          currentApml,
          selectedScreen,
          currentScreenData,
          messageSequence,
          userFeedback,
          chatHistory,
          appScreens,
          screenHistory,
          showTechnicalDetails,
          loadApp,
          loadScreen,
          getScreenButtons,
          handleButtonClick,
          sendChatMessage,
          clearMessageSequence,
          resetScreen,
          getSequenceStats,
          transitionToNextScreen,
          goBackToPreviousScreen
        };
      },
      
      template: `
        <div class="min-h-screen bg-gray-900 text-white">
          <!-- Header -->
          <header class="bg-gray-800 border-b border-gray-700 p-4">
            <div class="flex items-center justify-between">
              <h1 class="text-xl font-bold">ğŸ“± ProjectChat</h1>
              <div class="flex items-center space-x-4">
                <div class="text-sm text-gray-300">
                  <span class="font-semibold">{{ currentScreenData?.name || 'Loading...' }}</span>
                </div>
                <button 
                  v-if="screenHistory.length > 0"
                  @click="goBackToPreviousScreen"
                  class="px-3 py-1 bg-green-600 hover:bg-green-700 rounded text-sm"
                >
                  â† Back
                </button>
                <button 
                  @click="resetScreen"
                  class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded text-sm"
                >
                  ğŸ  Home
                </button>
                <button 
                  @click="showTechnicalDetails = !showTechnicalDetails"
                  :class="[
                    'px-3 py-1 rounded text-sm',
                    showTechnicalDetails ? 'bg-orange-600 hover:bg-orange-700' : 'bg-gray-600 hover:bg-gray-700'
                  ]"
                >
                  {{ showTechnicalDetails ? 'ğŸ‘ï¸ Hide Tech' : 'ğŸ”§ Show Tech' }}
                </button>
              </div>
            </div>
          </header>
          
          <div class="flex h-screen">
            <!-- Left Panel: App Flow Map + Chat -->
            <div class="w-1/4 bg-gray-800 border-r border-gray-700 p-4 overflow-y-auto flex flex-col">
              <!-- App Flow Map -->
              <div class="flex-1">
                <h2 class="text-lg font-semibold mb-4">ğŸ—ºï¸ App Flow</h2>
                
                <!-- Current Location -->
                <div v-if="currentScreenData" class="mb-4 p-3 bg-blue-900 rounded">
                  <div class="font-medium text-blue-100">ğŸ“ You are here</div>
                  <div class="text-sm text-blue-200">{{ currentScreenData.name }}</div>
                </div>
                
                <!-- Main App Sections -->
                <div class="space-y-3">
                  <div class="p-3 bg-gray-700 rounded">
                    <h3 class="text-sm font-medium mb-2 text-green-400">Main Sections</h3>
                    <div class="space-y-1">
                      <button
                        v-for="screen in appScreens.filter(s => ['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(s.id))"
                        :key="screen.id"
                        @click="loadScreen(screen)"
                        :class="[
                          'w-full text-left px-2 py-1 rounded text-xs transition-colors',
                          selectedScreen === screen.id 
                            ? 'bg-green-600 text-white' 
                            : 'bg-gray-600 hover:bg-gray-500 text-gray-300'
                        ]"
                      >
                        {{ selectedScreen === screen.id ? 'ğŸ‘‰' : 'ğŸ“„' }} {{ screen.name }}
                      </button>
                    </div>
                  </div>
                  
                  <div v-if="screenHistory.length > 0" class="p-3 bg-gray-700 rounded">
                    <h3 class="text-sm font-medium mb-2 text-purple-400">Recent Screens</h3>
                    <div class="space-y-1">
                      <button
                        v-for="(screen, index) in screenHistory.slice(-3)"
                        :key="screen.id + '-' + index"
                        @click="goBackToPreviousScreen"
                        class="w-full text-left px-2 py-1 rounded text-xs bg-gray-600 hover:bg-gray-500 text-gray-300"
                      >
                        â† {{ screen.name }}
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Chat with ADE Section -->
              <div class="border-t border-gray-700 pt-4 mt-4">
                <h3 class="text-sm font-semibold mb-2">ğŸ’¬ Feedback</h3>
                
                <div class="space-y-2 mb-3 max-h-24 overflow-y-auto">
                  <div
                    v-for="chat in chatHistory.slice(-2)"
                    :key="chat.timestamp"
                    :class="[
                      'p-2 rounded text-xs',
                      chat.type === 'user' ? 'bg-green-800 text-green-100' : 'bg-blue-800 text-blue-100'
                    ]"
                  >
                    <div class="font-medium">{{ chat.type === 'user' ? 'You' : 'ADE' }}</div>
                    <div>{{ chat.content }}</div>
                  </div>
                </div>
                
                <div class="flex">
                  <input
                    v-model="userFeedback"
                    @keyup.enter="sendChatMessage"
                    placeholder="How does this feel?"
                    class="flex-1 px-2 py-1 bg-gray-700 border border-gray-600 rounded-l text-xs text-white"
                  />
                  <button
                    @click="sendChatMessage"
                    class="px-3 py-1 bg-blue-600 hover:bg-blue-700 rounded-r text-xs text-white"
                  >
                    ğŸ’¬
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Center Panel: App Simulator -->
            <div :class="showTechnicalDetails ? 'w-1/2' : 'w-3/4'" class="bg-gray-900 p-4 overflow-y-auto transition-all duration-300">
              <div class="flex justify-center">
                <div v-if="!currentScreenData" class="text-center text-gray-400 mt-20">
                  <div class="text-6xl mb-4">ğŸ“±</div>
                  <p>Loading ProjectChat...</p>
                </div>
                
                <div v-else class="bg-white rounded-xl shadow-2xl" style="width: 320px; height: 560px; position: relative;">
                  <!-- Phone Frame -->
                  <div class="absolute inset-0 bg-black rounded-xl p-2">
                    <div class="bg-white rounded-lg h-full flex flex-col">
                      <!-- Status Bar -->
                      <div class="flex justify-between items-center px-4 py-2 text-xs text-gray-600 bg-gray-50 rounded-t-lg">
                        <span>9:41</span>
                        <span class="font-semibold">ProjectChat</span>
                        <span>ğŸ”‹100%</span>
                      </div>
                      
                      <!-- Screen Header -->
                      <div class="px-4 py-3 border-b border-gray-200">
                        <div class="flex items-center justify-between">
                          <div>
                            <h3 class="text-lg font-bold text-gray-800">{{ currentScreenData.name }}</h3>
                            <p class="text-xs text-gray-500">{{ currentScreenData.purpose }}</p>
                          </div>
                          <div v-if="screenHistory.length > 0">
                            <button 
                              @click="goBackToPreviousScreen"
                              class="text-blue-500 text-sm px-2 py-1 rounded hover:bg-blue-50"
                            >
                              â† Back
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Screen Content -->
                      <div class="flex-1 p-4 overflow-y-auto">
                        <div class="space-y-3">
                          <button
                            v-for="button in getScreenButtons()"
                            :key="button.id"
                            @click="handleButtonClick(button)"
                            class="w-full p-4 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors text-left shadow-md"
                          >
                            <div class="text-sm font-medium">{{ button.label }}</div>
                            <div class="text-xs opacity-75 mt-1">{{ button.description }}</div>
                          </button>
                        </div>
                      </div>
                      
                      <!-- Bottom Navigation (if main screen) -->
                      <div v-if="['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(currentScreenData.id)" class="border-t border-gray-200 bg-gray-50 px-4 py-2">
                        <div class="flex justify-around">
                          <button 
                            v-for="screen in appScreens.filter(s => ['chat_screen', 'task_screen', 'file_screen', 'team_screen'].includes(s.id))"
                            :key="screen.id"
                            @click="loadScreen(screen)"
                            :class="[
                              'flex flex-col items-center py-2 px-3 rounded text-xs transition-colors',
                              selectedScreen === screen.id 
                                ? 'text-blue-600 bg-blue-50' 
                                : 'text-gray-500 hover:text-gray-700'
                            ]"
                          >
                            <div class="text-lg mb-1">
                              {{ screen.id === 'chat_screen' ? 'ğŸ’¬' : 
                                  screen.id === 'task_screen' ? 'âœ…' : 
                                  screen.id === 'file_screen' ? 'ğŸ“' : 'ğŸ‘¥' }}
                            </div>
                            <div>{{ screen.name.replace(' Screen', '') }}</div>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Right Panel: Technical Details (Collapsible) -->
            <div v-if="showTechnicalDetails" class="w-1/4 bg-gray-800 border-l border-gray-700 p-4 overflow-y-auto transition-all duration-300">
              <h2 class="text-lg font-semibold mb-4">ğŸ”§ Technical Details</h2>
              
              <div class="space-y-4">
                <!-- APML Sequence -->
                <div>
                  <h3 class="text-sm font-medium mb-2 text-orange-400">APML Message Sequence</h3>
                  <div v-if="messageSequence.length > 0" class="space-y-2">
                    <div
                      v-for="message in messageSequence"
                      :key="message.timestamp"
                      :class="[
                        'p-2 rounded text-xs',
                        message.type === 'user-to-app' ? 'bg-green-900 text-green-100' :
                        message.type === 'app-to-app' ? 'bg-purple-900 text-purple-100' :
                        'bg-blue-900 text-blue-100'
                      ]"
                    >
                      <div class="font-medium">{{ message.type.replace('-', ' â†’ ').toUpperCase() }}</div>
                      <div>{{ message.content }}</div>
                    </div>
                  </div>
                  <div v-else class="text-center text-gray-400 py-8">
                    <div class="text-2xl mb-2">ğŸ”„</div>
                    <p class="text-xs">Interact with app to see APML sequence</p>
                  </div>
                </div>
                
                <!-- Screen Data -->
                <div v-if="currentScreenData" class="p-3 bg-gray-700 rounded">
                  <h3 class="text-sm font-medium mb-2 text-blue-400">Current Screen Data</h3>
                  <div class="text-xs text-gray-300 space-y-1">
                    <div><strong>ID:</strong> {{ currentScreenData.id }}</div>
                    <div><strong>Actions:</strong> {{ currentScreenData.actions?.length || 0 }}</div>
                    <div><strong>Purpose:</strong> {{ currentScreenData.purpose }}</div>
                  </div>
                </div>
                
                <!-- App Patterns -->
                <div v-if="currentApml?.patterns" class="p-3 bg-gray-700 rounded">
                  <h3 class="text-sm font-medium mb-2 text-purple-400">APML Patterns</h3>
                  <div class="text-xs text-gray-300 space-y-1">
                    <div>Userâ†’App: {{ currentApml.patterns.user_to_app?.length || 0 }}</div>
                    <div>Appâ†’App: {{ currentApml.patterns.app_to_app?.length || 0 }}</div>
                    <div>Appâ†’User: {{ currentApml.patterns.app_to_user?.length || 0 }}</div>
                  </div>
                </div>
              </div>
              
              <div class="mt-6 p-3 bg-gray-900 rounded border border-gray-600">
                <p class="text-xs text-gray-400">
                  <strong>ğŸ¯ For Developers:</strong> This shows the underlying APML processing. Regular users don't need to see this - they just experience the app flow.
                </p>
              </div>
            </div>
          </div>
        </div>
      `
    }).mount('#app');
  </script>
</body>
</html>